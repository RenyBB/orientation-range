<!DOCTYPE html>
<html>
    <head>
  	<script src="https://unpkg.com/jspsych"></script>
  	<script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
	<script src="https://unpkg.com/@jspsych/plugin-preload"></script>
	<script src="https://unpkg.com/@jspsych/plugin-browser-check@1.0.1"></script>
	<script src="https://unpkg.com/@jspsych/plugin-virtual-chinrest@2.0.1"></script>
  	<script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response"></script>
	<script src="https://unpkg.com/@jspsych/plugin-html-button-response"></script>
  	<script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response"></script>
    	<script src="https://unpkg.com/@jspsych/plugin-canvas-button-response"></script>
	    
      	<script src="jspsych-psychophysics.js"></script>
      	<script src="https://pixijs.download/release/pixi.js"></script>
	    
  	<link rel="stylesheet" href="https://unpkg.com/jspsych@7.1.2/css/jspsych.css"/>  
	<style>
      		html,body {
        	background-color: #808080;
        	color: white;
      		}
  	</style>
    </head>
    <body></body>
    <script>
      // This file demonstrates how to specify the mouse-event functions.
      // As you move the mouse, the slope of the line segment changes. 
      // By changing the direction of the mouse in motion,  the direction of rotation of the line changes.

      const jsPsych = initJsPsych({
        on_finish: function() {
            jsPsych.data.displayData();
        }
      })
      console.log(`jsPsych Version ${jsPsych.version()}`)

      const pixi_flag = jsPsych.data.getURLVariable('pixi_flag') === '1' ? true : false;
	    
      let true_orientation = [];
      const line_length = 100;
      let corrected_angle = [];
      let error = [];
	        
      // practice stimuli
      const training_stimuli = [
      { stimulus: "Gab_90.png", orientation: 90},  
      { stimulus: "Gab_0.png", orientation: 0},  
      ]; 
	    
      // test stimuli
      const test_stimuli = [
      { stimulus: "Gab_45.png", orientation: 45},
      { stimulus: "Gab_135.png", orientation: 135},
      ]; 
	    
      const browser_check = {
 	 type: jsPsychBrowserCheck,
	 minimum_width: 1500,
	 minimum_height: 750,
  	 inclusion_function: (data) => {
    		return data.mobile === false
  	},
  	exclusion_message: (data) => {
    		if(data.mobile){
      			return '<p>You must use a desktop/laptop computer to participate in this experiment.</p>';
    		} 
  	}
	};

	const virtual_chinrest = {
  		type: jsPsychVirtualChinrest,
  		blindspot_reps: 5,
  		resize_units: "deg",
  		pixels_per_unit: 50
		};

	    
      const instruction = {
          type: jsPsychHtmlButtonResponse,
          stimulus: 'Click on the Start button.',
          choices: ['Start'],
          prompt: "This is a sample program for the jspsych-psychophysics plugin.",
      }

      const circle_obj = {
          obj_type: 'circle',
          startX: 'center',
          startY: 'center',
          radius: 100,
          line_color: 'white',
          line_width: 5,
      };

      let prev_mouseX = null;
      let mouse_move_start = false;
      
      const line_obj = {
          obj_type: 'line',
          line_length: 200,
          line_color: 'black',
          line_width: 5,
          angle: function() {return Math.round(Math.random()*180)},
      };
	    
     var fixation = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: 'NO_KEYS',
      trial_duration: 1000,
    }

    var test = {
      type: jsPsychImageKeyboardResponse,
      stimulus: jsPsych.timelineVariable('stimulus'),
      choices: 'NO_KEYS',
      trial_duration: 500,
      maintain_aspect_ration: true,
      stimulus_height: 150
    }
	    

      const trial = {
          type: jsPsychPsychophysics,
          pixi: pixi_flag,
          canvas_offsetY: 100,
	  canvas_height: 800,
	  response_type: 'key',
          choices: [' '],
          prompt: '<p>Right-click to wake up mouse. Move mouse SLOWLY to the left or right to rotate the line.<br>When you are happy with the orientation of the line, right click to stop the line moving.Then press the spacebar to save your response. </p>',
          stimuli: [circle_obj, line_obj], // These can be referenced using the jsPsych.currentTrial().stim_array array.
          vert_button_margin: '50px',
          horiz_button_margin: '50px',
          mouse_down_func: function(event){
            mouse_move_start = !mouse_move_start;
          },                
          // mouse_up_func: function(event){ // This also works, but, please comment out the mouse_down_function.
          //   mouse_move_start = !mouse_move_start;
          // },
          mouse_move_func: function(event){ // This function will be automatically added as the event listener of the canvas.
            let a = [];
	    if (mouse_move_start === false) return;

            if (prev_mouseX === null){
              prev_mouseX = event.offsetX;
              return
            }

            // stim_array[0] means a circle, and stim_array[1] means a line.
            const line = pixi_flag ? jsPsych.getCurrentTrial().stim_array[1].pixi_obj : jsPsych.getCurrentTrial().stim_array[1];

            if (event.offsetX > prev_mouseX){
              line.angle += 1; // The angle changes by 1 degree.
            } else {
              line.angle -= 1;
            }
            prev_mouseX = event.offsetX;

	    console.log(`current orientation: ${jsPsych.getCurrentTrial().stim_array[1].angle}`);
          },
	 on_finish: function(data) {
		var selected_orientation = jsPsych.getCurrentTrial().stim_array[1].angle;
          
  	  	var positive_orientation = [];

		if (selected_orientation<0) {
			var negative_multiplier = Math.ceil(Math.abs(selected_orientation)/360);
			positive_orientation =  selected_orientation + 360*negative_multiplier;
        	}
		else { positive_orientation =  selected_orientation; }
	 
		var quadrant_angle = [];
		if (positive_orientation >= 360) {
	 		var positive_multiplier = Math.floor(positive_orientation /360);
	       		quadrant_angle = positive_orientation - 360*positive_multiplier; 	
		}
		else {quadrant_angle = positive_orientation;}

		corrected_angle = [];
		if (quadrant_angle>=0 && quadrant_angle<=90) {corrected_angle = quadrant_angle;}
		else if (quadrant_angle>90 && quadrant_angle<=180) {corrected_angle = 180 - quadrant_angle;}
		else if (quadrant_angle>180 && quadrant_angle<=270) {corrected_angle = quadrant_angle - 180;}
		else if (quadrant_angle>270 && quadrant_angle<=360) {corrected_angle = 360 - quadrant_angle;}

		console.log(`selected orientation: ${selected_orientation}`);
		console.log(`corrected orientation: ${corrected_angle}`);
	  	
		 
		error = [];
        	error = jsPsych.timelineVariable('orientation')-corrected_angle;
      		if (error>90) {
        		error = 180 - error;
     		 }
      		else if (error<-90) {
        		error = error + 180;
      		}
        	console.log(error);
		var feedback_colour = [];
     			if (Math.abs(error) < 5) { feedback_colour = 'green';}
      			else {feedback_colour = 'red';} 
		 
		data.selected_orientation = selected_orientation;
          	data.corrected_orientation = corrected_angle;
		data.feedback_colour = feedback_colour;
		data.error = error;
		
	}
      }

      
       const feedback= {
          type: jsPsychPsychophysics,
          pixi: pixi_flag,
          canvas_offsetY: 100,
	  canvas_height: 800,
          response_type: 'key',
          choices: [' '],
          prompt: '<p>The white line shows the true orienation of the grating. The colour line shows your response.<br>If the line is green, you were close to the true orientation of the grating. Press the spacebar to continue.</p>',
          stimuli: [circle_obj, 
		{
		obj_type: 'line',
          	line_length: 200,
          	line_color: function () {return jsPsych.data.get().last(1).values()[0].feedback_colour},
          	line_width: 5,
          	angle: function () {return jsPsych.data.get().last(1).values()[0].selected_orientation},
		},
		{
		obj_type: 'line',
          	line_length: 200,
          	line_color: 'white',
          	line_width: 5,
          	angle: function () {return 180-jsPsych.timelineVariable('orientation')}	
		    }   
		   ],
          vert_button_margin: '50px',
          horiz_button_margin: '50px'
	};
     
//timer	    
    const mkTimer = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<div style="font-size: 25px"><p>The next part of the experiment will start in</p>'
                + '<div style="font-size: 50px"><p><span id="clock">1:00</span></div></p>',
        choices: ['NO KEYS'],
        trial_duration: 10100,
        on_load: function(){
        var wait_time = 1 * 10 * 1000; // in milliseconds
    	var start_time = performance.now();
    	var interval = setInterval(function(){
      	var time_left = wait_time - (performance.now() - start_time);
      	var minutes = Math.floor(time_left / 1000 / 60);
      	var seconds = Math.floor((time_left - minutes*1000*60)/1000);
      	var seconds_str = seconds.toString().padStart(2,'0');
      	if(time_left <= 0){
		document.querySelector('#clock').innerHTML = minutes + ':' + seconds_str;
        	document.querySelector('#clock').innerHTML = "0:00";
        	document.querySelector('button').disabled = false;
        	clearInterval(interval);
            }
        }, 250)
        },
        on_finish: function(){
             clearInterval(interval);
            
        }};
    
	    
      // start the experiment 

      jsPsych.run([
	  instruction,
	  browser_check,
	  //virtual_chinrest, 
          {
            timeline: [fixation, test, trial, feedback],
            timeline_variables: training_stimuli,
      	    randomize_order: true,
            repetitions: 2
          },
	  mkTimer,
	  instruction,
	  {
            timeline: [fixation, test, trial, feedback],
            timeline_variables: test_stimuli,
      	    randomize_order: true,
            repetitions: 5
          },  
        ])

  </script>
</html>
